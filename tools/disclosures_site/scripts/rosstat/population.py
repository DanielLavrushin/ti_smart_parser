# parse population from Report Constructor (rosstat, adhoc script to run yearly)
# https://showdata.gks.ru/report/278928/?&filter_1_0=2019-01-01+00%3A00%3A00%7C-56%2C2020-01-01+00%3A00%3A00%7C-56%2C2021-01-01+00%3A00%3A00%7C-56&filter_2_0=127937&filter_3_0=13035%2C13441%2C13087%2C13091%2C13096%2C13109%2C13120%2C13148%2C13169%2C13180%2C13193%2C13202%2C13253%2C13281%2C13305%2C13310%2C13142%2C13319%2C13356%2C13200%2C13442%2C13388%2C13392%2C13078%2C13079%2C109349%2C13105%2C13137%2C13185%2C13229%2C13233%2C13268%2C13183%2C13443%2C108674%2C320258%2C13359%2C13384%2C108675%2C13041%2C13085%2C13101%2C13272%2C108676%2C108671%2C13373%2C13133%2C13379%2C13404%2C13402%2C13425%2C13062%2C13444%2C13361%2C13396%2C13399%2C13407%2C13416%2C13428%2C13260%2C109208%2C13166%2C13112%2C13248%2C13256%2C13172%2C13286%2C13338%2C13445%2C13177%2C13297%2C13323%2C13324%2C13329%2C109350%2C13341%2C13446%2C320380%2C13382%2C13413%2C13422%2C13036%2C109269%2C13048%2C109340%2C109342%2C13123%2C320402%2C109118%2C13238%2C13242%2C13313%2C13447%2C320381%2C13368%2C13348%2C13432%2C13153%2C109140%2C13056%2C13069%2C13073%2C13196%2C13292%2C13439%2C13353%2C108677&filter_4_0=170792%2C173935%2C155852%2C173936%2C155854%2C155855%2C155857%2C204599%2C155858%2C155859%2C155860%2C155861%2C155863%2C155864%2C155865%2C204601%2C204602%2C155866%2C155867%2C155868%2C155869%2C204603%2C155870%2C204604%2C155871%2C155872%2C155873%2C155874%2C155875%2C155876%2C155877%2C155878%2C155879%2C155880%2C155881%2C155882%2C155883%2C204607%2C155884%2C204609%2C204610%2C211936%2C204611%2C204612%2C155886%2C155887%2C155888%2C155889%2C155890%2C155891%2C155892%2C155893%2C155894%2C155895%2C155896%2C155897%2C155898%2C155899%2C155900%2C155901%2C155902%2C155903%2C211937%2C209086%2C173937%2C155904%2C170794%2C155905%2C155906%2C155907%2C155908%2C204616%2C155909%2C204617%2C155910%2C155911%2C155912%2C155913%2C155914%2C155915%2C155916%2C155917%2C155918%2C155919%2C155920%2C155921%2C155922%2C155923%2C155924%2C155925%2C155926%2C204620%2C155927%2C155928%2C204621%2C155929%2C155930%2C155931%2C155932%2C155933%2C155934%2C155935%2C204623%2C155936%2C155937%2C204624%2C155938%2C155939%2C155940%2C155941%2C155942%2C155943%2C155944%2C155945%2C155946%2C155947%2C155948%2C155949%2C155950%2C155951%2C155952%2C155953%2C155954%2C155955%2C155956%2C155957%2C204628%2C204629%2C155958%2C204630%2C155959%2C204631%2C204632%2C204633%2C204634%2C204635%2C155960%2C155961%2C155962%2C155963%2C204637%2C155964%2C155965%2C155966%2C155967%2C155968%2C155969%2C155970%2C155971%2C155972%2C155973%2C155974%2C204639%2C155975&rp_submit=t

from office_db.russian_regions import TRussianRegions
from disclosures_site.declarations.rosstat_data import TRossStatData, TRegionYearInfo


def main():
    regions = TRussianRegions()
    with open("/home/sokirko/pop2021.csv") as inp:
        data = dict()
        name = True
        region_id = None
        for l in inp:
            w = l.strip().split("\t")
            if name:
                r = w[0]
                r = regions.get_region_in_nominative(w[0])
                if r is None:
                    raise Exception("cannot fine {}".format(w[0]))
                region_id = r.id
                name = False
            else:
                assert l.startswith('Раздел')
                data[region_id] = list(map(int, w[-3:]))
                name = True

    for i in regions.iterate_regions_2021():
        if i.id not in  data:
            raise Exception("cannot find data for region_id={}".format(i.id))

    data1 = TRossStatData()
    data1.load_from_disk()
    for region_id, populations  in data.items():
        info2019 = data1.get_data(region_id, 2019)
        if info2019.population != populations[0]:
            raise Exception("region_id={} different data {} != {}".format(region_id, info2019.population, populations[0]))
        s = data1.get_data(region_id, 2021)
        assert  s.median_salary > 0
        s.population = populations[2]
        assert data1.get_data(region_id, 2020) is None
        data1.set_data(region_id, 2020, TRegionYearInfo(population=populations[1]))
    data1.save_to_disk(".new")


if __name__ == '__main__':
    main()